<!DOCTYPE html>
<html  lang="zh_CN" xmlns:th="http://www.thymeleaf.org"
       xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>欢迎页</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" href="css/bootstrap.min.css">
</head>
<body>
<div class="panel panel-default">
    <div class="panel-heading">了解BOOTWx平台</div>
    <div style="padding: 10px 0 20px 10px;">
        <h3>&nbsp;&nbsp;&nbsp;项目介绍</h3>
        <ul>
            <li>用户注册平台账户后，通过扫描二维码或导入数据的方式将微信号绑定到自己账户下面.</li>
            <li>平台使用用户绑定的微信号做任务，完成任务微信号获得佣金直接汇总到用户平台账户上.</li>
            <li>用户发起佣金提现，提现金额将在1个工作日内到账,用户获得现金收益.</li>
        </ul>
        <div id="existRandomIds">
        </div>
    </div>
    <div style="padding: 10px 0 20px 10px;">
        <div class="row">
            <div class="col-sm-6">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        <i class="fa fa-info-circle"></i> 扫描二维码
                    </div>
                    <div class="panel-body">
                        <p><b>1.点击下面【获取二维码】</b></p>
                        <p><b>2.用微信移动客户端扫描二维码</b></p>
                        <p><b>3.在微信移动客户端上确认授权登陆</b></p>
                        <p><img id="qrImg" src="" width="150px" height="150px" alt="" /></p>
                    </div>
                    <div class="panel-footer">
                        <input type="button" id="getQrCode" name="getQrCode" onclick="getQrCode()" value="获取二维码"/>
                    </div>
                </div>
            </div>
            <div class="col-sm-6">
                <form class="form-horizontal m-t" id="signupForm">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        62数据导入
                    </div>
                    <div class="panel-body">
                        <div class="ibox-content">
                            <p><b>1.点击下面选择文件</b></p>
                            <p><b>2.选择上传<span style="color: red;"> 规定格式 </span>的62数据txt</b></p>
                            <p><b>3.点击最下面的62数据导入，并等待结果</b></p>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">选择待上传62数据：</label>
                                <div class="col-sm-8">
                                    <input type="file" id="file1" name="myfile"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="panel-footer">
                        <!--<button type="submit" class="btn btn-primary">解析62数据</button>-->
                        <input type="submit" onclick="parseUpload()" value="62数据导入"/>
                    </div>
                </div>
                </form>
            </div>
        </div>
        <!--<ul>-->
           <!-- <li><input type="button" id="getQrCodeStatus" name="getQrCode" onclick="getQrCodeStatus()" value="获取二维码状态"/> </li>
            <li><input type="button" id="getLoginStatus" name="getLoginStatus" onclick="getLoginStatus()" value="获取登录状态"/> </li>
            <li><input type="button" id="getReadReady" name="getReadReady" onclick="getReadReady()" value="获取阅读准备数据"/> </li>
            <li><input type="button" id="contactOperateService" name="contactOperateService" onclick="contactOperateService()" value="关注公众号"/> </li>
            <li>
                <input type="button" id="upload62" name="upload62" onclick="upload62()" value="上传62TXT"/>
                <input type="hidden" id="62DataUrl" name="62DataUrl"/>
                <input type="button" id="解析62数据" name="upload62" onclick="parse62()" value="解析62数据"/>
                <br/>选择文件:<input type="file" id="file1" />
            </li>

            <li><input type="button" id="addUser" name="addUser" onclick="addUser()" value="new关注公众号"/> </li>-->
        <!--</ul>-->
    </div>
</div>
</body>
<script src="js/jquery.min.js"></script>
<script src="js/openTab.js"></script>
<script th:inline="javascript"> var ctx = [[@{/}]] ; </script>
<script type="text/javascript">
    var ind = "";
    var randomIds='${randomIds}';

    $(function(){
        handleRandomIds();
    })

    function parseUpload() {
        var formData = new FormData();
        var fi=document.getElementById("file1").files[0];
        if (fi!=null) {
            formData.append("myfile", fi);
            $.ajax({
                cache: true,
                type: "POST",
                url: "/wx/parseRecord/parse62Data",
                data: formData,// 你的formid
                /**
                 *必须false才会自动加上正确的Content-Type
                 */
                contentType: false,
                /**
                 * 必须false才会避开jQuery对 formdata 的默认处理
                 * XMLHttpRequest会对 formdata 进行正确的处理
                 */
                processData: false,
                async: false,
                error: function (request) {
                    parent.layer.alert("Connection error");
                },
                success: function (data) {
                    if (data.code == 0) {
                        parent.layer.alert("操作成功，请耐心等待上传结果，或者到：业务管理>微信62数据上传模块下，查看当前记录的导入明细。");
                        parent.reLoad();
                        var index = parent.layer.getFrameIndex(window.name); // 获取窗口索引
                        parent.layer.close(index);

                    } else {
                        parent.layer.alert(data.msg)
                    }

                }
            });
        }else{
            parent.layer.alert("请首先选择待上传的文件！（格式一定要对哦~）");
        }
    }

    function handleRandomIds() {
        $("#existRandomIds").empty();
        $(randomIds).each(function(index,element){
            $("#existRandomIds").append("<p>"+element+"<p>");
        })

    }

    function parse62(){
        var parUrl=$("#62DataUrl").val();
        if (parUrl != null && parUrl != undefined) {
            $.ajax({
                type: 'POST',
                url: "/wx/wxoperation/parse62Data",
                data:{url: parUrl},
                success: function (data) {
                    console.info(data);
                    if (data != null) {
                        $("#qrcodeUUID").html(data.uuid);
                        $("#randomId").val(data.uuid);
                        var qrImg=data.data.retdata;
                        console.info(qrImg);
                        if (qrImg != null&&qrImg!='') {
                            $("#qrImg").attr('src',qrImg);
                        }
                    }
                },
                dataType: "JSON"
            });
        }else {
            alert(0)
        }
    }

    function upload62(){
        var formData = new FormData();
        var fi=document.getElementById("file1").files[0];
        if (fi!=null){
            formData.append("myfile", fi);
            $.ajax({
                url: "/wx/wxoperation/upload62",
                type: "POST",
                data: formData,
                /**
                 *必须false才会自动加上正确的Content-Type
                 */
                contentType: false,
                /**
                 * 必须false才会避开jQuery对 formdata 的默认处理
                 * XMLHttpRequest会对 formdata 进行正确的处理
                 */
                processData: false,
                success: function (data) {
                    if (data != "") {
                        alert("上传成功！");
                        $("#62DataUrl").val(data);
                        document.getElementById("file1").files[0] = "";
                    }else{
                        alert(data.msg);
                        document.getElementById("file1").files[0] = "";
                    }

                },
                error: function () {
                    alert("上传失败！");
                    document.getElementById("file1").files[0] = "";
                }
            });
        }
    }

    function getQrCode(){
        $.ajax({
            type: 'POST',
            contentType:"application/json;charset=utf-8",
            url: "/wx/wxoperation/login_qrcode",
            data:JSON.stringify({
              /*  randomId: "asdf54wq6qwe65r4651aasdgas",*/
                account: "asd",
                softwareId: "666",
                autoLogin: true,
                protocolVer: 3,
                extraData: null,
                cmd: 502,
                now: new Date().getTime() // 注意不要在此行增加逗号
            }),
            success: function (data) {
                console.info(data);
                if (data != null) {
                    $("#qrcodeUUID").html(data.uuid);
                    $("#randomId").val(data.uuid);
                    var qrImg=data.data.retdata;
                    console.info(qrImg);
                    if (qrImg != null&&qrImg!='') {
                        $("#qrImg").attr('src',qrImg);
                    }
                }
            },
            dataType: "JSON"
        });
    }

    function getQrCodeStatus(){
        $.ajax({
            type: 'POST',
            contentType:"application/json;charset=utf-8",
            url: "/wx/wxoperation/login_status",
            data:JSON.stringify({
                randomId: $("#randomId").val(),
                account: "asd",
                softwareId: "666",
                autoLogin: true,
                extraData: null,
                protocolVer: 3,
                cmd: 6666,
                now: new Date().getTime() // 注意不要在此行增加逗号
            }),
            success: function (data) {
                if (data != null&&data.code==0) {
                    var qrImg=data.status.state.ImgBuf;
                    console.info(qrImg);
                    if (qrImg != null&&qrImg!='') {
                        qrImg = 'data:image/png;base64,' + qrImg;
                        $("#qrImg").attr('src',qrImg);
                        clearInterval(ind);
                    }
                }
            },
            dataType: "JSON"
        });
    }

    function getReadReady(){
        $.ajax({
            type: 'POST',
            contentType:"application/json;charset=utf-8",
            url: "/wx/wxoperation/getReadReady",
            data:JSON.stringify({
                randomId: $("#randomId").val(),
                account: "asd",
                softwareId: "666",
                autoLogin: true,
                extraData: null,
                protocolVer: 3,
                reqUrl: "https://mp.weixin.qq.com/s/O4cvFKd0cCwnTybRZAGm6g",
                scene: "7",
                username: "yindongli2018",
                cmd: 777,
                now: new Date().getTime() // 注意不要在此行增加逗号
            }),
            success: function (data) {
                if (data != null&&data.code==0) {
                    var qrImg=data.status.state.ImgBuf;
                    console.info(qrImg);
                    if (qrImg != null&&qrImg!='') {
                        qrImg = 'data:image/png;base64,' + qrImg;
                        $("#qrImg").attr('src',qrImg);
                        clearInterval(ind);
                    }
                }
            },
            dataType: "JSON"
        });
        // $.post("?randomId="+$("#randomId").val()+"&reqUrl=https://mp.weixin.qq.com/s/ExMUO0KuWwNyqdfgIwTw8A&scene=7&username=yindongli2018",function (data) {
        //     if (data != null&&data.code==0) {
        //         console.info(data);
        //     }
        // });
    }

    function getUpload62(){
        $.post("/wx/wxoperation/getLoginStatus?randomId="+$("#randomId").val(),function (data) {
            if (data != null&&data.code==0) {
                console.info(data);
            }
        });
    }

    function getLoginStatus(){
        $.post("/wx/wxoperation/getLoginStatus?randomId="+$("#randomId").val(),function (data) {
            if (data != null&&data.code==0) {
                console.info(data);
            }
        });
    }

    function contactOperateService(){
        $.post("/wx/wxoperation/contactOperateService?randomId="+$("#randomId").val(),function (data) {
            if (data != null&&data.code==0) {
                console.info(data);
            }
        });
    }

    function addUser(){
        $.ajax({
            type: 'POST',
            contentType:"application/json;charset=utf-8",
            url: "/wx/wxoperation/addUser",
            data:JSON.stringify({
                randomId: $("#randomId").val(),
                account: "asd",
                softwareId: "666",
                autoLogin: true,
                extraData: null,
                protocolVer: 3,
                reqUrl: "https://mp.weixin.qq.com/s/O4cvFKd0cCwnTybRZAGm6g",
                scene: "3",
                username: "yindongli2018",
                gzwxId:"caozhi163",
                cmd: 999,
                now: new Date().getTime() // 注意不要在此行增加逗号
            }),
            success: function (data) {
                if (data != null&&data.code==0) {
                    var qrImg=data.status.state.ImgBuf;
                    console.info(qrImg);
                    if (qrImg != null&&qrImg!='') {
                        qrImg = 'data:image/png;base64,' + qrImg;
                        $("#qrImg").attr('src',qrImg);
                        clearInterval(ind);
                    }
                }
            },
            dataType: "JSON"
        });
    }
</script>
</html>